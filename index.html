<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPK - å¤šè¯åº“å¯¹æˆ˜ç‰ˆ</title>
    <script src="https://cdn.goeasy.io/goeasy-2.6.6.min.js"></script>
    <style>
        :root { --primary: #2ea44f; --bg: #f6f8fa; --card-bg: #ffffff; --text: #24292e; --success: #28a745; --error: #d73a49; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 10px; }
        .container { width: 100%; max-width: 500px; background: var(--card-bg); padding: 2rem; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border: 1px solid #e1e4e8; }
        .hidden { display: none !important; }
        h1 { text-align: center; color: var(--text); margin-bottom: 1.5rem; }
        input, button, select { width: 100%; padding: 10px; margin-bottom: 1rem; border-radius: 6px; border: 1px solid #e1e4e8; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        button:disabled { background: #94d3a2; cursor: wait; }
        .word-box { font-size: 2rem; text-align: center; margin: 2rem 0; font-weight: 800; color: #0366d6; }
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .opt-btn { background: #fafbfc; border: 1px solid #d1d5da; color: #24292e; padding: 15px 5px; cursor: pointer; border-radius: 6px; transition: 0.2s;}
        .opt-btn:hover { background: #f3f4f6; }
        .opt-btn.correct { background: var(--success); color: white; border-color: var(--success); }
        .opt-btn.wrong { background: var(--error); color: white; border-color: var(--error); }
        .player-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eaecef; }
        .dict-select-box { background: #fffbdd; padding: 15px; border-radius: 6px; border: 1px solid #e1e4e8; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div id="view-home">
        <h1>ğŸ“š WordPK å¯¹æˆ˜</h1>
        <input type="hidden" id="app-key" value="BC-519c0e3b87cb47ab99f68886dee2b2f9">
        <input type="text" id="nick" placeholder="è¾“å…¥æ˜µç§°" maxlength="8">
        <button onclick="createRoom()">æˆ‘æ˜¯æˆ¿ä¸»ï¼šåˆ›å»ºæˆ¿é—´</button>
        <div style="display:flex; gap:10px;">
            <input type="text" id="room-code" placeholder="è¾“å…¥æˆ¿é—´å·" style="margin-bottom:0">
            <button onclick="joinRoom()" style="margin-bottom:0; width:40%; background:#6a737d">åŠ å…¥</button>
        </div>
    </div>

    <div id="view-lobby" class="hidden">
        <div style="text-align:center; margin-bottom:20px;">
            <p style="color:#586069; font-size:14px;">æˆ¿é—´å·</p>
            <b id="lobby-room-id" style="font-size:24px; color:#0366d6; letter-spacing: 2px;"></b>
        </div>
        
        <div id="host-panel" class="hidden" style="margin-bottom:20px;">
            <div class="dict-select-box">
                <label style="font-size:14px; color:#666; display:block; margin-bottom:5px;">è¯·é€‰æ‹©æœ¬å±€è¯åº“ï¼š</label>
                <select id="dict-selector">
                    <option value="words.txt">é»˜è®¤è¯åº“ (words.txt)</option>
                    <option value="cet4.txt">è‹±è¯­å››çº§ (cet4.txt)</option>
                    <option value="cet6.txt">è‹±è¯­å…­çº§ (cet6.txt)</option>
                    <option value="kaoyan.txt">è€ƒç ”æ ¸å¿ƒ (kaoyan.txt)</option>
                </select>
                <button onclick="loadAndStart()" id="start-btn">åŠ è½½è¯åº“å¹¶å¼€å§‹</button>
                <div id="loading-tip" style="font-size:12px; color:#666; text-align:center;"></div>
            </div>
        </div>

        <div id="guest-msg" style="text-align:center; color:#586069; padding: 20px;">ç­‰å¾…æˆ¿ä¸»é€‰æ‹©è¯åº“...</div>
        <div><h4>å½“å‰ç©å®¶</h4><div id="lobby-players"></div></div>
    </div>

    <div id="view-game" class="hidden">
        <div style="display:flex; justify-content:space-between; font-weight:bold; color:#586069; font-size: 14px;">
            <span id="round-idx">Round 1</span><span id="my-score">å¾—åˆ†: 0</span>
        </div>
        <div class="word-box" id="q-word">Loading...</div>
        <div class="opt-grid" id="q-opts"></div>
        <div style="margin-top:20px; border-top:1px solid #eaecef; padding-top:10px;">
            <small>ğŸ† å®æ—¶æ’è¡Œ</small><div id="game-ranks"></div>
        </div>
    </div>
</div>

<script>
    let goeasy = null, myNick = "", roomId = "", isHost = false, myScore = 0;
    let players = {}, fullWordList = [];

    const show = (id) => {
        ['view-home','view-lobby','view-game'].forEach(v => document.getElementById(v).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    };

    function initGoEasy() {
        if(goeasy) return; 
        goeasy = GoEasy.getInstance({ host: "hangzhou.goeasy.io", appkey: document.getElementById('app-key').value, modules: ['pubsub'] });
        goeasy.connect({ onSuccess: () => console.log("GoEasy Connected") });
    }

    function createRoom() {
        const n = document.getElementById('nick').value.trim();
        if(!n) return alert("è¯·è¾“å…¥æ˜µç§°");
        myNick = n; initGoEasy();
        roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
        isHost = true;
        enterLobby();
    }

    function joinRoom() {
        const n = document.getElementById('nick').value.trim();
        const c = document.getElementById('room-code').value.trim().toUpperCase();
        if(!n || !c) return alert("è¯·è¾“å…¥ä¿¡æ¯");
        myNick = n; roomId = c; initGoEasy();
        isHost = false;
        enterLobby();
        setTimeout(() => sendMsg({ type: 'JOIN' }), 500);
    }

    function enterLobby() {
        show('view-lobby');
        document.getElementById('lobby-room-id').innerText = roomId;
        if(isHost) document.getElementById('host-panel').classList.remove('hidden');
        
        goeasy.pubsub.subscribe({ 
            channel: roomId, 
            onMessage: (m) => handleMessage(JSON.parse(m.content)) 
        });
    }

    // ğŸ¯ æ ¸å¿ƒä¿®æ”¹ï¼šæ ¹æ®ä¸‹æ‹‰èœå•è¯»å–ä¸åŒæ–‡ä»¶
    function loadAndStart() {
        const filename = document.getElementById('dict-selector').value;
        const btn = document.getElementById('start-btn');
        const tip = document.getElementById('loading-tip');
        
        btn.disabled = true;
        btn.innerText = "æ­£åœ¨è¯»å– " + filename + "...";
        
        // åŠ ä¸Šæ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
        fetch(filename + '?v=' + new Date().getTime())
            .then(res => {
                if(!res.ok) throw new Error("GitHubä¸Šæ‰¾ä¸åˆ°æ–‡ä»¶: " + filename);
                return res.text();
            })
            .then(text => {
                // è§£æè¯åº“
                fullWordList = text.split('\n').map(line => {
                    line = line.trim();
                    if(!line) return null;
                    let parts = line.split(/,|ï¼Œ/);
                    if(parts.length < 2) {
                        let firstSpace = line.indexOf(' ');
                        if(firstSpace > 0) parts = [line.substring(0, firstSpace), line.substring(firstSpace).trim()];
                    }
                    if(parts && parts.length >= 2) return { en: parts[0].trim(), zh: parts[1].trim() };
                    return null;
                }).filter(i => i);
                
                if(fullWordList.length < 5) throw new Error("è¯åº“å•è¯å¤ªå°‘äº†");
                
                tip.innerHTML = `âœ… æˆåŠŸåŠ è½½ ${fullWordList.length} ä¸ªå•è¯ï¼Œå³å°†å¼€å§‹...`;
                setTimeout(startGameLoop, 1000); // 1ç§’åå¼€å§‹
            })
            .catch(err => {
                alert("åŠ è½½å¤±è´¥ï¼è¯·ç¡®è®¤ä½ æ˜¯å¦å·²å°† " + filename + " ä¸Šä¼ åˆ°GitHubï¼Ÿ\né”™è¯¯ä¿¡æ¯: " + err.message);
                btn.disabled = false;
                btn.innerText = "åŠ è½½è¯åº“å¹¶å¼€å§‹";
            });
    }

    function handleMessage(data) {
        if(data.senderId) {
            players[data.senderId] = { nick: data.nick, score: data.score || 0 };
            renderPlayers();
        }
        if(data.type === 'JOIN' && isHost) sendMsg({ type: 'WELCOME' });
        else if(data.type === 'QUESTION') renderQuestion(data.payload);
    }

    function sendMsg(payload) {
        goeasy.pubsub.publish({ 
            channel: roomId, 
            message: JSON.stringify({ ...payload, senderId: myNick+"_"+roomId, nick: myNick, score: myScore }) 
        });
    }

    function startGameLoop() {
        let round = 0;
        const total = 15; 
        const nextQ = () => {
            if(round >= total) return; 
            round++;
            const correct = fullWordList[Math.floor(Math.random()*fullWordList.length)];
            let opts = [correct.zh];
            while(opts.length < 4) {
                const r = fullWordList[Math.floor(Math.random()*fullWordList.length)].zh;
                if(!opts.includes(r)) opts.push(r);
            }
            opts.sort(()=>Math.random()-0.5); 
            sendMsg({ type: 'QUESTION', payload: { round, total, word: correct.en, opts, ans: correct.zh } });
            setTimeout(nextQ, 5000);
        };
        nextQ();
    }

    function renderQuestion(q) {
        show('view-game');
        document.getElementById('round-idx').innerText = `Round ${q.round} / ${q.total}`;
        document.getElementById('q-word').innerText = q.word;
        const box = document.getElementById('q-opts');
        box.innerHTML = '';
        let answered = false;
        q.opts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                if(answered) return;
                answered = true;
                const isRight = (opt === q.ans);
                btn.className += isRight ? ' correct' : ' wrong';
                if(isRight) { myScore += 10; document.getElementById('my-score').innerText = "å¾—åˆ†: " + myScore; }
                sendMsg({ type: 'SCORE_UPDATE' });
            };
            box.appendChild(btn);
        });
    }

    function renderPlayers() {
        const list = Object.values(players).sort((a,b)=>b.score - a.score);
        const html = list.map(p => `<div class="player-row"><span>${p.nick}</span><b style="color:${p.score>0?'#28a745':'#999'}">${p.score}</b></div>`).join('');
        const area = document.getElementById('view-lobby').classList.contains('hidden') ? 'game-ranks' : 'lobby-players';
        document.getElementById(area).innerHTML = html;
    }
</script>
</body>
</html>
